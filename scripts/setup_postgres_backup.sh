#!/bin/bash
# Setup PostgreSQL Automatic Backup via Cron
# Creates daily backups at 02:00 AM, keeps last 30 days

set -e  # Exit on error

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ðŸ—„ï¸  Setting up PostgreSQL automatic backup...${NC}"

# Configuration
BACKUP_DIR="/home/$(whoami)/backups/postgres"
DB_NAME="bist_data"
DB_USER="ademcelik"
RETENTION_DAYS=30

# Create backup directory
echo -e "${YELLOW}ðŸ“ Creating backup directory: $BACKUP_DIR${NC}"
mkdir -p "$BACKUP_DIR"
echo -e "${GREEN}âœ… Backup directory created${NC}"

# Create backup script
BACKUP_SCRIPT="$BACKUP_DIR/backup.sh"
echo -e "${YELLOW}ðŸ“ Creating backup script: $BACKUP_SCRIPT${NC}"

cat > "$BACKUP_SCRIPT" << 'EOF'
#!/bin/bash
# PostgreSQL Backup Script
# Auto-generated by setup_postgres_backup.sh

BACKUP_DIR="/home/$(whoami)/backups/postgres"
DB_NAME="bist_data"
DB_USER="ademcelik"
RETENTION_DAYS=30
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz"

# Create backup
pg_dump -U "$DB_USER" "$DB_NAME" | gzip > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "âœ… Backup successful: $BACKUP_FILE"
    
    # Get file size
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "ðŸ“Š Backup size: $SIZE"
    
    # Delete old backups (keep last N days)
    find "$BACKUP_DIR" -name "${DB_NAME}_*.sql.gz" -mtime +$RETENTION_DAYS -delete
    echo "ðŸ—‘ï¸  Old backups cleaned (keeping last $RETENTION_DAYS days)"
else
    echo "âŒ Backup failed!"
    exit 1
fi
EOF

chmod +x "$BACKUP_SCRIPT"
echo -e "${GREEN}âœ… Backup script created${NC}"

# Test backup
echo -e "${YELLOW}ðŸ§ª Testing backup...${NC}"
bash "$BACKUP_SCRIPT"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ… Test backup successful!${NC}"
    
    # List backup files
    echo -e "${YELLOW}ðŸ“‹ Current backups:${NC}"
    ls -lh "$BACKUP_DIR"/*.sql.gz 2>/dev/null || echo "No backups yet"
else
    echo -e "${RED}âŒ Test backup failed!${NC}"
    exit 1
fi

# Add to crontab
echo -e "${YELLOW}â° Adding to crontab (daily at 02:00 AM)...${NC}"

# Check if crontab entry already exists
if crontab -l 2>/dev/null | grep -q "$BACKUP_SCRIPT"; then
    echo -e "${YELLOW}âš ï¸  Crontab entry already exists, skipping...${NC}"
else
    # Add new crontab entry
    (crontab -l 2>/dev/null; echo "0 2 * * * $BACKUP_SCRIPT >> $BACKUP_DIR/backup.log 2>&1") | crontab -
    echo -e "${GREEN}âœ… Crontab entry added${NC}"
fi

# Show crontab
echo -e "${YELLOW}ðŸ“‹ Current crontab entries:${NC}"
crontab -l | grep -v "^#" | grep -v "^$"

echo -e "${GREEN}âœ¨ PostgreSQL automatic backup setup complete!${NC}"
echo -e "${YELLOW}ðŸ“Š Summary:${NC}"
echo -e "  â€¢ Backup directory: $BACKUP_DIR"
echo -e "  â€¢ Database: $DB_NAME"
echo -e "  â€¢ Schedule: Daily at 02:00 AM"
echo -e "  â€¢ Retention: $RETENTION_DAYS days"
echo -e "  â€¢ Backup script: $BACKUP_SCRIPT"
echo -e "  â€¢ Log file: $BACKUP_DIR/backup.log"
